<div class="content-wrapper">
    <!-- Header da Página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-edit text-primary me-2"></i>
                Editar Ordem de Compra #<%= ordemCompra.id %>
            </h1>
            <p class="text-muted mb-0">Edite os dados da ordem de compra</p>
        </div>
        <div>
            <% if (ordemCompra.status === 'planejado') { %>
                <button type="button" class="btn btn-success-custom me-2" onclick="aprovarOrdemCompra()">
                    <i class="fas fa-check-circle me-2"></i>
                    Aprovar para Purchase Order
                </button>
            <% } %>
            <% if (ordemCompra.status === 'aprovado') { %>
                <a href="/planejamento/purchase-order/<%= ordemCompra.id %>" class="btn btn-info-custom me-2">
                    <i class="fas fa-file-contract me-2"></i>
                    Ver Purchase Order
                </a>
            <% } %>
            <a href="/planejamento/ordem-compra/<%= ordemCompra.id %>" class="btn btn-info-custom me-2">
                <i class="fas fa-eye me-2"></i>
                Visualizar
            </a>
            <a href="/planejamento/ordem-compra/<%= ordemCompra.id %>/historico" class="btn btn-secondary-custom me-2">
                <i class="fas fa-history me-2"></i>
                Histórico
            </a>
            <a href="/planejamento/ordem-compra" class="btn btn-secondary-custom">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Formulário Principal -->
        <div class="col-lg-8">
            <div class="card-custom">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart text-primary me-2"></i>
                        Dados da Ordem de Compra
                    </h5>
                </div>
                <div class="card-body">
                    <form action="/planejamento/ordem-compra/<%= ordemCompra.id %>" method="POST" id="ordemCompraForm">
                        <!-- Seção: Informações Gerais da OC -->
                        <div class="section-header mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Informações Gerais
                            </h6>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="numero_oc" class="form-label-custom">
                                    <i class="fas fa-hashtag me-1"></i>
                                    Número da OC
                                </label>
                                <input type="text" class="form-control-custom" id="numero_oc" name="numero_oc"
                                       value="<%= ordemCompra.numero_oc || '' %>">
                            </div>
                            <div class="col-md-4">
                                <label for="fornecedor" class="form-label-custom">
                                    <i class="fas fa-building me-1"></i>
                                    Fornecedor
                                </label>
                                <input type="text" class="form-control-custom" id="fornecedor" name="fornecedor"
                                       value="<%= ordemCompra.fornecedor || '' %>">
                            </div>
                            <div class="col-md-4">
                                <label for="status_oc" class="form-label-custom">
                                    <i class="fas fa-tasks me-1"></i>
                                    Status da OC
                                </label>
                                <select class="form-control-custom" id="status_oc" name="status_oc">
                                    <option value="rascunho" <%= ordemCompra.status === 'rascunho' ? 'selected' : '' %>>Rascunho</option>
                                    <option value="emitida" <%= ordemCompra.status === 'emitida' ? 'selected' : '' %>>Emitida</option>
                                    <option value="aprovada" <%= ordemCompra.status === 'aprovada' ? 'selected' : '' %>>Aprovada</option>
                                    <option value="em_transito" <%= ordemCompra.status === 'em_transito' ? 'selected' : '' %>>Em Trânsito</option>
                                    <option value="recebida" <%= ordemCompra.status === 'recebida' ? 'selected' : '' %>>Recebida</option>
                                    <option value="cancelada" <%= ordemCompra.status === 'cancelada' ? 'selected' : '' %>>Cancelada</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="data_emissao" class="form-label-custom">
                                    <i class="fas fa-calendar-plus me-1"></i>
                                    Data de Emissão
                                </label>
                                <input type="date" class="form-control-custom" id="data_emissao" name="data_emissao"
                                       value="<%= ordemCompra.data_emissao ? new Date(ordemCompra.data_emissao).toISOString().split('T')[0] : '' %>">
                            </div>
                            <div class="col-md-6">
                                <label for="data_entrega_prevista" class="form-label-custom">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    Data de Entrega Prevista
                                </label>
                                <input type="date" class="form-control-custom" id="data_entrega_prevista" name="data_entrega_prevista"
                                       value="<%= ordemCompra.data_entrega_prevista ? new Date(ordemCompra.data_entrega_prevista).toISOString().split('T')[0] : '' %>">
                            </div>
                        </div>

                        <div class="row mb-5">
                            <div class="col-12">
                                <label for="observacoes" class="form-label-custom">
                                    <i class="fas fa-sticky-note me-1"></i>
                                    Observações
                                </label>
                                <textarea class="form-control-custom" id="observacoes" name="observacoes" rows="3"><%= ordemCompra.observacoes || '' %></textarea>
                            </div>
                        </div>

                        <!-- Seção: Itens da Ordem de Compra -->
                        <div class="section-header mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Itens da Ordem de Compra
                                </h6>
                                <button type="button" class="btn btn-success btn-sm" id="addItemBtn">
                                    <i class="fas fa-plus me-2"></i>
                                    Adicionar Item
                                </button>
                            </div>
                        </div>

                        <div id="itemsContainer" data-familias='<%- JSON.stringify(familias) %>' data-tamanhos='<%- JSON.stringify(tamanhos) %>' data-cores='<%- JSON.stringify(cores) %>' data-item-count='<%- (ordemCompra.itens || []).length || 1 %>'>
                            <!-- Nova estrutura: múltiplos itens -->
                            <% if (!ordemCompra.itens || ordemCompra.itens.length === 0) { %>
                                <!-- Item padrão quando não há itens -->
                                <div class="item-card card mb-4 border-primary" data-item-id="new">
                                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-box me-2"></i>
                                            Item 1
                                        </h6>
                                        <button type="button" class="btn btn-danger btn-sm remove-item-btn" disabled>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-users me-1"></i>
                                                    Família *
                                                </label>
                                                <select class="form-control-custom familia-select" name="itens[0][familia_id]" required>
                                                    <option value="">Selecione uma família</option>
                                                    <% familias.forEach(familia => { %>
                                                        <option value="<%= familia.id %>" <%= familia.id == ordemCompra.familia_id ? 'selected' : '' %>><%= familia.nome %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-expand me-1"></i>
                                                    Tamanho *
                                                </label>
                                                <select class="form-control-custom tamanho-select" name="itens[0][tamanho_id]" required>
                                                    <option value="">Selecione um tamanho</option>
                                                    <% tamanhos.forEach(tamanho => { %>
                                                        <option value="<%= tamanho.id %>" <%= tamanho.id == ordemCompra.tamanho_id ? 'selected' : '' %>><%= tamanho.sigla || tamanho.nome %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-palette me-1"></i>
                                                    Cor *
                                                </label>
                                                <select class="form-control-custom cor-select" name="itens[0][cor_id]" required>
                                                    <option value="">Selecione uma cor</option>
                                                    <% cores.forEach(cor => { %>
                                                        <option value="<%= cor.id %>" <%= cor.id == ordemCompra.cor_id ? 'selected' : '' %>><%= cor.nome %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-barcode me-1"></i>
                                                    SKU (Gerado Automaticamente)
                                                </label>
                                                <input type="text" class="form-control-custom sku-input" name="itens[0][sku]" value="<%= ordemCompra.sku %>" readonly>
                                                <div class="form-text">Será atualizado automaticamente baseado na família, tamanho e cor selecionados</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-tasks me-1"></i>
                                                    Status *
                                                </label>
                                                <select class="form-control-custom" name="itens[0][status]" required>
                                                    <option value="pendente" <%= ordemCompra.status === 'planejado' ? 'selected' : '' %>>Pendente</option>
                                                    <option value="aprovado" <%= ordemCompra.status === 'aprovado' ? 'selected' : '' %>>Aprovado</option>
                                                    <option value="em_transito" <%= ordemCompra.status === 'em_transito' ? 'selected' : '' %>>Em Trânsito</option>
                                                    <option value="recebido" <%= ordemCompra.status === 'recebido' ? 'selected' : '' %>>Recebido</option>
                                                    <option value="cancelado" <%= ordemCompra.status === 'cancelado' ? 'selected' : '' %>>Cancelado</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-hashtag me-1"></i>
                                                    Quantidade *
                                                </label>
                                                <input type="number" class="form-control-custom quantidade-input" name="itens[0][quantidade]"
                                                       step="0.01" min="0" value="<%= ordemCompra.quantidade %>" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-balance-scale me-1"></i>
                                                    Unidade de Medida *
                                                </label>
                                                <select class="form-control-custom unidade-select" name="itens[0][unidade_medida]" required>
                                                    <option value="">Selecione a unidade</option>
                                                    <option value="unidade" <%= ordemCompra.unidade_medida === 'unidade' ? 'selected' : '' %>>Unidade</option>
                                                    <option value="kg" <%= ordemCompra.unidade_medida === 'kg' ? 'selected' : '' %>>Quilograma (kg)</option>
                                                    <option value="metro" <%= ordemCompra.unidade_medida === 'metro' ? 'selected' : '' %>>Metro</option>
                                                    <option value="metro_quadrado" <%= ordemCompra.unidade_medida === 'metro_quadrado' ? 'selected' : '' %>>Metro Quadrado (m²)</option>
                                                    <option value="litro" <%= ordemCompra.unidade_medida === 'litro' ? 'selected' : '' %>>Litro</option>
                                                    <option value="peca" <%= ordemCompra.unidade_medida === 'peca' ? 'selected' : '' %>>Peça</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-money-bill-wave me-1"></i>
                                                    Valor Unitário R$ *
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="number" class="form-control-custom valor-unitario-input" name="itens[0][valor_unitario_brl]"
                                                           step="0.01" min="0" value="<%= ordemCompra.valor_compra_brl ? (ordemCompra.valor_compra_brl / ordemCompra.quantidade).toFixed(2) : '' %>" required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-exchange-alt me-1"></i>
                                                    Cotação Dólar *
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="number" class="form-control-custom cotacao-input" name="itens[0][cotacao_dolar]"
                                                           step="0.0001" min="0" value="<%= ordemCompra.cotacao_dolar %>" required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-dollar-sign me-1"></i>
                                                    Valor Total R$
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="number" class="form-control-custom valor-total-input" name="itens[0][valor_total_brl]"
                                                           step="0.01" value="<%= ordemCompra.valor_compra_brl %>" readonly>
                                                </div>
                                                <div class="form-text">Calculado automaticamente</div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label-custom">
                                                    <i class="fas fa-calendar-check me-1"></i>
                                                    ETD Planejado *
                                                </label>
                                                <input type="date" class="form-control-custom" name="itens[0][etd_planejado]"
                                                       value="<%= new Date(ordemCompra.etd_planejado).toISOString().split('T')[0] %>" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% } %>

                            <% ordemCompra.itens && ordemCompra.itens.forEach((item, index) => { %>
                                    <div class="item-card card mb-4 border-primary" data-item-id="<%= item.id %>">
                                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-box me-2"></i>
                                                Item <%= index + 1 %> - <%= item.familia_nome %> <%= item.tamanho_nome %> <%= item.cor_nome %>
                                            </h6>
                                            <button type="button" class="btn btn-danger btn-sm remove-item-btn" <%= ordemCompra.itens.length === 1 ? 'disabled' : '' %>>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-users me-1"></i>
                                                        Família *
                                                    </label>
                                                    <select class="form-control-custom familia-select" name="itens[<%= index %>][familia_id]" required>
                                                        <option value="">Selecione uma família</option>
                                                        <% familias.forEach(familia => { %>
                                                            <option value="<%= familia.id %>" <%= familia.id == item.familia_id ? 'selected' : '' %>><%= familia.nome %></option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-expand me-1"></i>
                                                        Tamanho *
                                                    </label>
                                                    <select class="form-control-custom tamanho-select" name="itens[<%= index %>][tamanho_id]" required>
                                                        <option value="">Selecione um tamanho</option>
                                                        <% tamanhos.forEach(tamanho => { %>
                                                            <option value="<%= tamanho.id %>" <%= tamanho.id == item.tamanho_id ? 'selected' : '' %>><%= tamanho.sigla || tamanho.nome %></option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-palette me-1"></i>
                                                        Cor *
                                                    </label>
                                                    <select class="form-control-custom cor-select" name="itens[<%= index %>][cor_id]" required>
                                                        <option value="">Selecione uma cor</option>
                                                        <% cores.forEach(cor => { %>
                                                            <option value="<%= cor.id %>" <%= cor.id == item.cor_id ? 'selected' : '' %>><%= cor.nome %></option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-barcode me-1"></i>
                                                        SKU (Gerado Automaticamente)
                                                    </label>
                                                    <input type="text" class="form-control-custom sku-input" name="itens[<%= index %>][sku]" value="<%= item.sku %>" readonly>
                                                    <div class="form-text">Será atualizado automaticamente baseado na família, tamanho e cor selecionados</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-tasks me-1"></i>
                                                        Status *
                                                    </label>
                                                    <select class="form-control-custom" name="itens[<%= index %>][status]" required>
                                                        <option value="pendente" <%= item.status === 'pendente' ? 'selected' : '' %>>Pendente</option>
                                                        <option value="aprovado" <%= item.status === 'aprovado' ? 'selected' : '' %>>Aprovado</option>
                                                        <option value="em_transito" <%= item.status === 'em_transito' ? 'selected' : '' %>>Em Trânsito</option>
                                                        <option value="recebido" <%= item.status === 'recebido' ? 'selected' : '' %>>Recebido</option>
                                                        <option value="cancelado" <%= item.status === 'cancelado' ? 'selected' : '' %>>Cancelado</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-hashtag me-1"></i>
                                                        Quantidade *
                                                    </label>
                                                    <input type="number" class="form-control-custom quantidade-input" name="itens[<%= index %>][quantidade]"
                                                           step="0.01" min="0" value="<%= item.quantidade %>" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-balance-scale me-1"></i>
                                                        Unidade de Medida *
                                                    </label>
                                                    <select class="form-control-custom unidade-select" name="itens[<%= index %>][unidade_medida]" required>
                                                        <option value="">Selecione a unidade</option>
                                                        <option value="unidade" <%= item.unidade_medida === 'unidade' ? 'selected' : '' %>>Unidade</option>
                                                        <option value="kg" <%= item.unidade_medida === 'kg' ? 'selected' : '' %>>Quilograma (kg)</option>
                                                        <option value="metro" <%= item.unidade_medida === 'metro' ? 'selected' : '' %>>Metro</option>
                                                        <option value="metro_quadrado" <%= item.unidade_medida === 'metro_quadrado' ? 'selected' : '' %>>Metro Quadrado (m²)</option>
                                                        <option value="litro" <%= item.unidade_medida === 'litro' ? 'selected' : '' %>>Litro</option>
                                                        <option value="peca" <%= item.unidade_medida === 'peca' ? 'selected' : '' %>>Peça</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-money-bill-wave me-1"></i>
                                                        Valor Unitário R$ *
                                                    </label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R$</span>
                                                        <input type="number" class="form-control-custom valor-unitario-input" name="itens[<%= index %>][valor_unitario_brl]"
                                                               step="0.01" min="0" value="<%= Number(item.valor_unitario_brl || 0).toFixed(2) %>" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-exchange-alt me-1"></i>
                                                        Cotação Dólar *
                                                    </label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R$</span>
                                                        <input type="number" class="form-control-custom cotacao-input" name="itens[<%= index %>][cotacao_dolar]"
                                                               step="0.0001" min="0" value="<%= Number(item.cotacao_dolar || 0).toFixed(4) %>" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-dollar-sign me-1"></i>
                                                        Valor Total R$
                                                    </label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">R$</span>
                                                        <input type="number" class="form-control-custom valor-total-input" name="itens[<%= index %>][valor_total_brl]"
                                                               step="0.01" value="<%= Number(item.valor_total_brl || 0).toFixed(2) %>" readonly>
                                                    </div>
                                                    <div class="form-text">Calculado automaticamente</div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label-custom">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        ETD Planejado *
                                                    </label>
                                                    <input type="date" class="form-control-custom" name="itens[<%= index %>][etd_planejado]"
                                                           value="<%= new Date(item.etd_planejado).toISOString().split('T')[0] %>" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                        </div>

                        <!-- Seção: Resumo da OC -->
                        <div class="card bg-light mt-4 mb-4">
                            <div class="card-body">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-calculator me-2"></i>
                                    Resumo da Ordem de Compra
                                </h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Total de Itens:</strong>
                                        <span class="badge bg-primary ms-2" id="totalItens"><%= (ordemCompra.itens || []).length || 1 %></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Valor Total R$:</strong>
                                        <span class="text-success fw-bold ms-2" id="valorTotalBRL">R$ <%= Number(ordemCompra.valor_total_brl || ordemCompra.valor_compra_brl || 0).toFixed(2) %></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Valor Total USD:</strong>
                                        <span class="text-success fw-bold ms-2" id="valorTotalUSD">$ <%= Number(ordemCompra.valor_total_usd || 0).toFixed(2) %></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção: Botões de Ação -->
                        <div class="section-header mb-4">
                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-primary-custom">
                                    <i class="fas fa-save me-2"></i>
                                    Atualizar Ordem de Compra
                                </button>
                                <button type="reset" class="btn btn-secondary-custom">
                                    <i class="fas fa-undo me-2"></i>
                                    Restaurar Valores
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar com Informações -->
        <div class="col-lg-4">
            <!-- Informações e Dicas -->
            <div class="card-custom">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        Informações
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info-custom mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Dica:</strong> O SKU será atualizado automaticamente ao alterar família, tamanho ou cor.
                    </div>

                    <div class="alert alert-warning-custom mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> Alterações no SKU podem afetar relatórios e integrações existentes.
                    </div>

                    <div class="alert alert-success-custom">
                        <i class="fas fa-plus-circle me-2"></i>
                        <strong>Multi-item:</strong> Você pode adicionar vários produtos diferentes nesta mesma ordem de compra.
                    </div>
                </div>
            </div>

            <!-- Informações do Sistema -->
            <div class="card-custom mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-primary me-2"></i>
                        Informações do Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-12">
                            <small class="text-muted">ID da Ordem</small>
                            <div class="fw-bold">#<%= ordemCompra.id %></div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12">
                            <small class="text-muted">Data de Criação</small>
                            <div class="fw-bold"><%= new Date(ordemCompra.created_at).toLocaleString('pt-BR') %></div>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-12">
                            <small class="text-muted">Última Atualização</small>
                            <div class="fw-bold"><%= new Date(ordemCompra.updated_at).toLocaleString('pt-BR') %></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.item-card {
    transition: all 0.3s ease;
}

.item-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.remove-item-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.section-header {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}
</style>

<script>
// Função para gerar SKU automaticamente
function gerarSKU(familiaSelect, tamanhoSelect, corSelect, skuInput) {
    if (familiaSelect.value && tamanhoSelect.value && corSelect.value) {
        const familiaText = familiaSelect.options[familiaSelect.selectedIndex].text;
        const tamanhoText = tamanhoSelect.options[tamanhoSelect.selectedIndex].text;
        const corText = corSelect.options[corSelect.selectedIndex].text;

        skuInput.value = `${familiaText}-${tamanhoText}-${corText}`;
    }
}

// Função para calcular valor total
function calcularTotal(quantidadeInput, valorUnitarioInput, valorTotalInput) {
    const quantidade = parseFloat(quantidadeInput.value) || 0;
    const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
    const total = quantidade * valorUnitario;

    valorTotalInput.value = total.toFixed(2);
    atualizarResumo();
}

// Função para atualizar resumo da OC
function atualizarResumo() {
    let totalItens = document.querySelectorAll('.item-card').length;
    let valorTotalBRL = 0;

    document.querySelectorAll('.valor-total-input').forEach(input => {
        valorTotalBRL += parseFloat(input.value) || 0;
    });

    document.getElementById('totalItens').textContent = totalItens;
    document.getElementById('valorTotalBRL').textContent = `R$ ${valorTotalBRL.toFixed(2)}`;
    document.getElementById('valorTotalUSD').textContent = `$ ${(valorTotalBRL / 5.0).toFixed(2)}`; // Cotação aproximada
}

// Função para adicionar novo item
function addItem() {
    const container = document.getElementById('itemsContainer');
    const familias = JSON.parse(container.dataset.familias);
    const tamanhos = JSON.parse(container.dataset.tamanhos);
    const cores = JSON.parse(container.dataset.cores);
    let itemCounter = parseInt(container.dataset.itemCount) || 1;

    itemCounter++;
    container.dataset.itemCount = itemCounter;

    const itemCard = document.createElement('div');
    itemCard.className = 'item-card card mb-4 border-primary';
    itemCard.setAttribute('data-item-id', `new-${itemCounter}`);

    itemCard.innerHTML = `
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-box me-2"></i>
                Item ${itemCounter}
            </h6>
            <button type="button" class="btn btn-danger btn-sm remove-item-btn">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label-custom">
                        <i class="fas fa-users me-1"></i>
                        Família *
                    </label>
                    <select class="form-control-custom familia-select" name="itens[new-${itemCounter}][familia_id]" required>
                        <option value="">Selecione uma família</option>
                        ${familias.map(f => `<option value="${f.id}">${f.nome}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label-custom">
                        <i class="fas fa-expand me-1"></i>
                        Tamanho *
                    </label>
                    <select class="form-control-custom tamanho-select" name="itens[new-${itemCounter}][tamanho_id]" required>
                        <option value="">Selecione um tamanho</option>
                        ${tamanhos.map(t => `<option value="${t.id}">${t.sigla || t.nome}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label-custom">
                        <i class="fas fa-palette me-1"></i>
                        Cor *
                    </label>
                    <select class="form-control-custom cor-select" name="itens[new-${itemCounter}][cor_id]" required>
                        <option value="">Selecione uma cor</option>
                        ${cores.map(c => `<option value="${c.id}">${c.nome}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label-custom">
                        <i class="fas fa-barcode me-1"></i>
                        SKU (Gerado Automaticamente)
                    </label>
                    <input type="text" class="form-control-custom sku-input" name="itens[new-${itemCounter}][sku]" readonly>
                    <div class="form-text">Será atualizado automaticamente baseado na família, tamanho e cor selecionados</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label-custom">
                        <i class="fas fa-tasks me-1"></i>
                        Status *
                    </label>
                    <select class="form-control-custom" name="itens[new-${itemCounter}][status]" required>
                        <option value="pendente">Pendente</option>
                        <option value="aprovado">Aprovado</option>
                        <option value="em_transito">Em Trânsito</option>
                        <option value="recebido">Recebido</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label-custom">
                        <i class="fas fa-hashtag me-1"></i>
                        Quantidade *
                    </label>
                    <input type="number" class="form-control-custom quantidade-input" name="itens[new-${itemCounter}][quantidade]"
                           step="0.01" min="0" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label-custom">
                        <i class="fas fa-balance-scale me-1"></i>
                        Unidade de Medida *
                    </label>
                    <select class="form-control-custom unidade-select" name="itens[new-${itemCounter}][unidade_medida]" required>
                        <option value="">Selecione a unidade</option>
                        <option value="unidade">Unidade</option>
                        <option value="kg">Quilograma (kg)</option>
                        <option value="metro">Metro</option>
                        <option value="metro_quadrado">Metro Quadrado (m²)</option>
                        <option value="litro">Litro</option>
                        <option value="peca">Peça</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label-custom">
                        <i class="fas fa-money-bill-wave me-1"></i>
                        Valor Unitário R$ *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" class="form-control-custom valor-unitario-input" name="itens[new-${itemCounter}][valor_unitario_brl]"
                               step="0.01" min="0" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label-custom">
                        <i class="fas fa-exchange-alt me-1"></i>
                        Cotação Dólar *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" class="form-control-custom cotacao-input" name="itens[new-${itemCounter}][cotacao_dolar]"
                               step="0.0001" min="0" value="5.0000" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label-custom">
                        <i class="fas fa-dollar-sign me-1"></i>
                        Valor Total R$
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" class="form-control-custom valor-total-input" name="itens[new-${itemCounter}][valor_total_brl]"
                               step="0.01" readonly>
                    </div>
                    <div class="form-text">Calculado automaticamente</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="form-label-custom">
                        <i class="fas fa-calendar-check me-1"></i>
                        ETD Planejado *
                    </label>
                    <input type="date" class="form-control-custom" name="itens[new-${itemCounter}][etd_planejado]" required>
                </div>
            </div>
        </div>
    `;

    container.appendChild(itemCard);
    attachEventListeners(itemCard);
    atualizarResumo();
}

// Função para remover item
function removeItem(button) {
    const itemCard = button.closest('.item-card');
    const totalItems = document.querySelectorAll('.item-card').length;

    if (totalItems > 1) {
        itemCard.remove();
        atualizarResumo();
    }
}

// Função para anexar event listeners a um item
function attachEventListeners(itemCard) {
    const familiaSelect = itemCard.querySelector('.familia-select');
    const tamanhoSelect = itemCard.querySelector('.tamanho-select');
    const corSelect = itemCard.querySelector('.cor-select');
    const skuInput = itemCard.querySelector('.sku-input');
    const quantidadeInput = itemCard.querySelector('.quantidade-input');
    const valorUnitarioInput = itemCard.querySelector('.valor-unitario-input');
    const valorTotalInput = itemCard.querySelector('.valor-total-input');
    const removeBtn = itemCard.querySelector('.remove-item-btn');

    // Event listeners para SKU
    familiaSelect.addEventListener('change', () => gerarSKU(familiaSelect, tamanhoSelect, corSelect, skuInput));
    tamanhoSelect.addEventListener('change', () => gerarSKU(familiaSelect, tamanhoSelect, corSelect, skuInput));
    corSelect.addEventListener('change', () => gerarSKU(familiaSelect, tamanhoSelect, corSelect, skuInput));

    // Event listeners para cálculo
    quantidadeInput.addEventListener('input', () => calcularTotal(quantidadeInput, valorUnitarioInput, valorTotalInput));
    valorUnitarioInput.addEventListener('input', () => calcularTotal(quantidadeInput, valorUnitarioInput, valorTotalInput));

    // Event listener para remover
    removeBtn.addEventListener('click', () => removeItem(removeBtn));
}

// Event listeners
document.getElementById('addItemBtn').addEventListener('click', addItem);

// Anexar event listeners aos itens existentes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.item-card').forEach(attachEventListeners);
    atualizarResumo();
});

function aprovarOrdemCompra() {
    if (confirm('Tem certeza que deseja aprovar esta ordem de compra?\n\nEla será movida para o fluxo de Purchase Order e não poderá mais ser editada como uma ordem de compra comum.')) {
        // Enviar requisição POST para aprovar
        fetch('/planejamento/ordem-compra/<%= ordemCompra.id %>/approve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'  // Incluir cookies de autenticação
        })
        .then(response => {
            if (response.status === 401) {
                alert('Sessão expirada. Faça login novamente.');
                window.location.href = '/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                alert('Ordem de compra aprovada com sucesso! Redirecionando para Purchase Order...');
                window.location.href = data.redirectUrl || '/planejamento/purchase-order/<%= ordemCompra.id %>';
            } else if (data) {
                alert('Erro ao aprovar ordem de compra: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao aprovar ordem de compra. Tente novamente.');
        });
    }
}
</script>